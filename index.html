<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Workerbee by Achal-Aggarwal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Workerbee</h1>
      <h2 class="project-tagline">A worker bee for your hive.</h2>
      <a href="https://github.com/Achal-Aggarwal/workerbee" class="btn">View on GitHub</a>
      <a href="https://github.com/Achal-Aggarwal/workerbee/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/Achal-Aggarwal/workerbee/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="workerbee" class="anchor" href="#workerbee" aria-hidden="true"><span class="octicon octicon-link"></span></a>Workerbee</h3>

<p>It’s a bee that could be used to perform various task with Apache Hive. Inspired from tools like Beetest, HiveRunner, hive_test.</p>

<h3>
<a id="schema-at-one-place" class="anchor" href="#schema-at-one-place" aria-hidden="true"><span class="octicon octicon-link"></span></a>Schema at one place</h3>

<p>Workerbee enables you to define schema of database and tables along side of Map - Reduce programs. Once written they can be managed by changing java code. Using MigrationGenerator, migrations can generated which can be run against the database that need to migrate.</p>

<h3>
<a id="query-builder-at-disposal" class="anchor" href="#query-builder-at-disposal" aria-hidden="true"><span class="octicon octicon-link"></span></a>Query Builder at disposal</h3>

<p>Workerbee comes with basic query builder that comes handy when you don’t want to commit any typos while writing queries. No need to remember or lookup tables and their schema just to check column's order and type.</p>

<h3>
<a id="go-with-tdd" class="anchor" href="#go-with-tdd" aria-hidden="true"><span class="octicon octicon-link"></span></a>Go with TDD</h3>

<p>TDD is a wonderful approach to write minimal code required to do the work at hand. Workerbee allows you to write tests using unit test frameworks like JUnit. Using it you can formulate test for each case scenario and run it against setup data. Using data objects, created for each row of concerning table, more explicit assertions can made to get better assertion message on test failure.</p>

<h3>
<a id="domain-model-object-to-use-in-map-reduce-programs" class="anchor" href="#domain-model-object-to-use-in-map-reduce-programs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Domain model object to use in Map-Reduce programs</h3>

<p>When requirements gets complex and hive query could not handle it, writing map reduce program is a good option. But to read data and construct objects on which operations could be performed, knowledge of raw format or schema of the table is needed. Workerbee take care of this requirement, by extending Row of a table its behaviour could be extended.</p>

<h3>
<a id="supported-hive-version" class="anchor" href="#supported-hive-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>Supported Hive version</h3>

<p>Currently workerbee supports hive version 0.13, but query builder doesn’t support everything that is in it, yet.</p>

<h3>
<a id="example-scenario" class="anchor" href="#example-scenario" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example scenario</h3>

<p>With baseball statistics like bats man name, runs scored, the year for years 1871 - 2011, find the player with the highest runs for each year.</p>

<p><strong>Setting up project:</strong></p>

<p>I. Clone the repo and build with mvn install</p>

<p>II. Add dependency </p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
   &lt;<span class="pl-ent">groupId</span>&gt;com.workerbee&lt;/<span class="pl-ent">groupId</span>&gt;
   &lt;<span class="pl-ent">artifactId</span>&gt;workerbee-core&lt;/<span class="pl-ent">artifactId</span>&gt;
   &lt;<span class="pl-ent">version</span>&gt;1.0-SNAPSHOT&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>III. Add env variable HADOOP_HOME which points to your hadoop location.</p>

<p>IV. Make sure hive-exec*.jar is present at HADOOP_HOME/share/hadoop/common/lib</p>

<p><strong>Creating Database &amp; table:</strong></p>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">BaseBall</span> <span class="pl-k">extends</span> <span class="pl-e">Database</span> {
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">BaseBall</span> db <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">BaseBall</span>();

  <span class="pl-k">private</span> <span class="pl-en">BaseBall</span>() {
    <span class="pl-v">super</span>(<span class="pl-s"><span class="pl-pds">"</span>BaseBall<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>BaseBall database<span class="pl-pds">"</span></span>);
  }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Batting</span> <span class="pl-k">extends</span> <span class="pl-e">Table&lt;<span class="pl-smi">Batting</span>&gt;</span> {
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">Batting</span> tb <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Batting</span>();

  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">Column</span> playerId <span class="pl-k">=</span> HavingColumn(tb, <span class="pl-s"><span class="pl-pds">"</span>player_id<span class="pl-pds">"</span></span>, <span class="pl-smi">Column</span><span class="pl-k">.</span><span class="pl-smi">Type</span><span class="pl-c1"><span class="pl-k">.</span>STRING</span>);
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">Column</span> year     <span class="pl-k">=</span> HavingColumn(tb, <span class="pl-s"><span class="pl-pds">"</span>year<span class="pl-pds">"</span></span>,      <span class="pl-smi">Column</span><span class="pl-k">.</span><span class="pl-smi">Type</span><span class="pl-c1"><span class="pl-k">.</span>INT</span>);
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">Column</span> runs     <span class="pl-k">=</span> HavingColumn(tb, <span class="pl-s"><span class="pl-pds">"</span>runs<span class="pl-pds">"</span></span>,      <span class="pl-smi">Column</span><span class="pl-k">.</span><span class="pl-smi">Type</span><span class="pl-c1"><span class="pl-k">.</span>INT</span>);

  <span class="pl-k">private</span> <span class="pl-en">Batting</span>() {
    <span class="pl-v">super</span>(<span class="pl-smi">BaseBall</span><span class="pl-k">.</span>db, <span class="pl-s"><span class="pl-pds">"</span>Batting<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Batting table<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span>);
  }
}</pre></div>

<p><strong>Genrating migration files</strong></p>

<div class="highlight highlight-java"><pre><span class="pl-smi">MigrationGenerator</span><span class="pl-k">.</span>generateFilesFor(<span class="pl-smi">BaseBall</span><span class="pl-k">.</span>db, <span class="pl-k">new</span> <span class="pl-smi">File</span>(<span class="pl-s"><span class="pl-pds">"</span>PATH_TO_MIGRATION_FOLDER<span class="pl-pds">"</span></span>));</pre></div>

<p>Above statement will generate file with filename "TIMESTAMP_TABLE_VERSION_TABLE_NAME.hql" and contents
<code>CREATE TABLE IF NOT EXISTS BaseBall.Batting ( player_id STRING, year INT, runs INT ) COMMENT 'Batting table' ;</code></p>

<p><strong>Writing Test - Using Junit4:</strong></p>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">PlayerWithHighestRunForEachYear</span>() {
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">PLAYER_1_ID</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>PLAYER1_ID<span class="pl-pds">"</span></span>;
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">PLAYER_2_ID</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>PLAYER2_ID<span class="pl-pds">"</span></span>;
  <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">PLAYER_3_ID</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>PLAYER3_ID<span class="pl-pds">"</span></span>;
  <span class="pl-k">private</span> <span class="pl-smi">Repository</span> repo;
  <span class="pl-k">private</span> <span class="pl-k">Row&lt;<span class="pl-smi">Batting</span>&gt;</span> lowestRun
    <span class="pl-k">=</span> <span class="pl-smi">Batting</span><span class="pl-k">.</span>tb<span class="pl-k">.</span>getNewRow()
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>playerId, <span class="pl-c1">PLAYER_1_ID</span>)
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year, <span class="pl-c1">1990</span>)
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs, <span class="pl-c1">10</span>);

  <span class="pl-k">private</span> <span class="pl-k">Row&lt;<span class="pl-smi">Batting</span>&gt;</span> mediumRun
    <span class="pl-k">=</span> <span class="pl-smi">Batting</span><span class="pl-k">.</span>tb<span class="pl-k">.</span>getNewRow()
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>playerId, <span class="pl-c1">PLAYER_2_ID</span>)
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year, <span class="pl-c1">1990</span>)
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs, <span class="pl-c1">100</span>);

  <span class="pl-k">private</span> <span class="pl-k">Row&lt;<span class="pl-smi">Batting</span>&gt;</span> maximumRun
    <span class="pl-k">=</span> <span class="pl-smi">Batting</span><span class="pl-k">.</span>tb<span class="pl-k">.</span>getNewRow()
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>playerId, <span class="pl-c1">PLAYER_3_ID</span>)
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year, <span class="pl-c1">2000</span>)
    .set(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs, <span class="pl-c1">50</span>);

  <span class="pl-k">public</span> <span class="pl-en">BaseBallTest</span>() <span class="pl-k">throws</span> <span class="pl-smi">IOException</span>, <span class="pl-smi">SQLException</span> {
    repo <span class="pl-k">=</span> <span class="pl-smi">Repository</span><span class="pl-k">.</span>TemporaryRepository();
    repo<span class="pl-k">.</span>execute(create(<span class="pl-smi">BaseBall</span><span class="pl-k">.</span>db)<span class="pl-k">.</span>ifNotExist());
  }

  <span class="pl-k">@Test</span>
  <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">shouldReturnPlayerWithHighestScoreForEachYear</span>() <span class="pl-k">throws</span> <span class="pl-smi">IOException</span>, <span class="pl-smi">SQLException</span> {
    repo<span class="pl-k">.</span>setUp(<span class="pl-smi">Batting</span><span class="pl-k">.</span>tb);
    repo<span class="pl-k">.</span>setUp(<span class="pl-smi">Batting</span><span class="pl-k">.</span>tb)
      .setUp(<span class="pl-smi">Batting</span><span class="pl-k">.</span>tb, lowestRun, mediumRun, maximumRun);

    <span class="pl-k">List&lt;<span class="pl-k">Row&lt;<span class="pl-smi">Table</span>&gt;</span>&gt;</span> years <span class="pl-k">=</span> repo<span class="pl-k">.</span>execute(<span class="pl-c1">QUERY_TO_TEST</span>);

    assertThat(years<span class="pl-k">.</span>size(), is(<span class="pl-c1">2</span>));

    assertThat(years<span class="pl-k">.</span>get(<span class="pl-c1">0</span>)<span class="pl-k">.</span>getString(<span class="pl-smi">Batting</span><span class="pl-k">.</span>playerId), is(<span class="pl-c1">PLAYER_2_ID</span>));
    assertThat(years<span class="pl-k">.</span>get(<span class="pl-c1">0</span>)<span class="pl-k">.</span>getInt(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year), is(<span class="pl-c1">1990</span>));
    assertThat(years<span class="pl-k">.</span>get(<span class="pl-c1">0</span>)<span class="pl-k">.</span>getInt(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs), is(<span class="pl-c1">100</span>));

    assertThat(years<span class="pl-k">.</span>get(<span class="pl-c1">1</span>)<span class="pl-k">.</span>getString(<span class="pl-smi">Batting</span><span class="pl-k">.</span>playerId), is(<span class="pl-c1">PLAYER_3_ID</span>));
    assertThat(years<span class="pl-k">.</span>get(<span class="pl-c1">1</span>)<span class="pl-k">.</span>getInt(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year), is(<span class="pl-c1">2000</span>));
    assertThat(years<span class="pl-k">.</span>get(<span class="pl-c1">1</span>)<span class="pl-k">.</span>getInt(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs), is(<span class="pl-c1">50</span>));
  }
}</pre></div>

<p><strong>Writing queries</strong>
The next step is to group the data by year so we can find the highest score for each year. This query first groups all the records by year and then selects the player with the highest runs from each year.</p>

<div class="highlight highlight-java"><pre>select(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year, max(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs))
  .from(<span class="pl-smi">Batting</span><span class="pl-k">.</span>tb)
  .groupBy(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year)</pre></div>

<p>Now we need to go back and get the player_id(s) so we know who the player(s) was. We know that for a given year we can use the runs to find the player(s) for that year. So we can take the previous query and join it with the batting records to get the final table.</p>

<div class="highlight highlight-java"><pre><span class="pl-smi">SelectQuery</span> selectQuery <span class="pl-k">=</span> select(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year, max(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs))
  .from(<span class="pl-smi">Batting</span><span class="pl-k">.</span>tb)
  .groupBy(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year)
  .ascOrderOf(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year)
  .as(<span class="pl-s"><span class="pl-pds">"</span>MaxRunsForEachYear<span class="pl-pds">"</span></span>);

<span class="pl-k">Table&lt;<span class="pl-smi">Table</span>&gt;</span> maxRunsForEachYear <span class="pl-k">=</span> selectQuery<span class="pl-k">.</span>table();

select(<span class="pl-smi">Batting</span><span class="pl-k">.</span>playerId, <span class="pl-smi">Batting</span><span class="pl-k">.</span>year, <span class="pl-smi">Batting</span><span class="pl-k">.</span>runs)<span class="pl-k">.</span>from(<span class="pl-smi">Batting</span><span class="pl-k">.</span>tb)
  .join(selectQuery)
  .on(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year<span class="pl-k">.</span>eq(maxRunsForEachYear<span class="pl-k">.</span>getColumn(<span class="pl-smi">Batting</span><span class="pl-k">.</span>year))
      .and(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs<span class="pl-k">.</span>eq(maxRunsForEachYear<span class="pl-k">.</span>getColumn(<span class="pl-smi">Batting</span><span class="pl-k">.</span>runs)))
  )</pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Achal-Aggarwal/workerbee">Workerbee</a> is maintained by <a href="https://github.com/Achal-Aggarwal">Achal-Aggarwal</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

